<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Results - Student Result Management System</title>
    
    <!-- Modern Design System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-design.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--background-primary);
      color: var(--text-primary);
    }

    .main-content {
      padding: var(--space-2xl) 0;
      min-height: calc(100vh - 80px);
    }

    .form-section {
      max-width: 800px;
      margin: 40px auto;
      background: white;
      padding: 40px;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border-color);
    }

    /* Upload Area Styles */
    .upload-area {
      border: 3px dashed var(--border-color);
      border-radius: var(--radius-lg);
      padding: 60px 20px;
      text-align: center;
      background: var(--background-secondary);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }

    .upload-area:hover, .upload-area.dragover {
      border-color: var(--primary-500);
      background: var(--primary-50);
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 16px;
      color: var(--primary-500);
    }

    .upload-area h3 {
      color: var(--text-primary);
      margin: 0 0 8px 0;
      font-size: 24px;
      font-weight: 600;
    }

    .upload-area p {
      color: #6c757d;
      margin: 0 0 20px 0;
      font-size: 16px;
    }

    .browse-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .browse-btn:hover {
      background: #0056b3;
    }

    .file-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #e8f5e8;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .file-details {
      display: flex;
      flex-direction: column;
    }

    .file-name {
      font-weight: 600;
      color: #155724;
    }

    .file-size {
      font-size: 14px;
      color: #6c757d;
    }

    .remove-file {
      background: #dc3545;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
    }

    .file-limit {
      font-size: 14px;
      color: #6c757d;
      text-align: center;
      margin-bottom: 30px;
    }

    /* Selection Row */
    .selection-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }

    select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      transition: border-color 0.3s;
    }

    select:focus {
      outline: none;
      border-color: #007bff;
    }

    /* Processing Options */
    .processing-options {
      margin-bottom: 30px;
    }

    .processing-options h4 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #495057;
    }

    .option-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .option-card {
      display: flex;
      align-items: flex-start;
      padding: 16px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      background: #f8f9fa;
      transition: all 0.3s;
    }

    .option-card:has(input:checked) {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .option-card input[type="checkbox"] {
      margin-right: 12px;
      margin-top: 2px;
    }

    .option-content h5 {
      margin: 0 0 4px 0;
      font-size: 16px;
      font-weight: 600;
      color: #495057;
    }

    .option-content p {
      margin: 0;
      font-size: 14px;
      color: #6c757d;
    }

    button#uploadBtn {
      width: 100%;
      padding: 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      transition: all 0.3s;
    }

    button#uploadBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    button#uploadBtn:not(:disabled):hover {
      background: #218838;
    }

    .spinner {
      display: none;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 16px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #notification {
      margin-top: 20px;
      padding: 16px;
      display: none;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    /* Progress tracking styles */
    .progress-container {
      margin-top: 20px;
      display: none;
    }

    .progress-step {
      display: flex;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #6c757d;
    }

    .progress-step.active {
      border-left-color: #007bff;
      background: #e3f2fd;
    }

    .progress-step.completed {
      border-left-color: #28a745;
      background: #d4edda;
    }

    .progress-step.failed {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .step-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .step-text {
      flex: 1;
    }

    .step-details {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      margin: 10px 0;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: #007bff;
      transition: width 0.3s ease;
      width: 0%;
    }

    .batch-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }

    .stats-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .stat-card {
      text-align: center;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #dee2e6;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #007bff;
    }

    .stat-label {
      font-size: 12px;
      color: #6c757d;
      margin-top: 5px;
    }
  </style>
</head>
<body>
    <!-- Modern Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <path d="M8 7h8"></path>
                    <path d="M8 11h8"></path>
                    <path d="M8 15h6"></path>
                </svg>
                <span>Result Management</span>
            </a>
            
            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Dashboard</a></li>
                <li><a href="/upload" class="navbar-link active">Upload Results</a></li>
                <li><a href="/placement" class="navbar-link">Placement</a></li>
                <li><a href="/training-placement" class="navbar-link">Training & Placement</a></li>
                <li><a href="{{ url_for('data_files') }}" class="navbar-link">Data Files</a></li>
            </ul>
            
            <div class="navbar-actions">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/logout'">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="main-content">
      <div class="form-section">
    <form id="uploadForm" enctype="multipart/form-data">
      <!-- Drag and Drop Area -->
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">‚òÅÔ∏è</div>
        <h3>Drop your PDF here</h3>
        <p>or click to browse files</p>
        <button type="button" class="browse-btn" id="browseBtn">üìÅ Browse Files</button>
        <input type="file" name="pdf" id="pdfInput" accept="application/pdf" style="display: none;" required />
      </div>
      
      <div class="file-info" id="fileInfo" style="display: none;">
        <div class="file-details">
          <span class="file-name" id="fileName"></span>
          <span class="file-size" id="fileSize"></span>
        </div>
        <button type="button" class="remove-file" id="removeFile">‚úï</button>
      </div>
      
      <p class="file-limit">Maximum file size: 50MB. Only PDF files are supported.</p>

      <!-- Format and Exam Type Selection -->
      <div class="selection-row">
        <div class="form-group">
          <label>‚öôÔ∏è Format Type</label>
          <select id="formatSelect" name="format" required>
            <option value="">Select Format</option>
            <option value="jntuk">JNTUK</option>
            <option value="autonomous">Autonomous</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>üìã Exam Type</label>
          <select id="examTypeSelect" name="exam_type" required>
            <option value="">Select Exam Type</option>
            <option value="regular">Regular</option>
            <option value="supply">Supply</option>
          </select>
        </div>
      </div>

      <!-- Processing Options -->
      <div class="processing-options">
        <h4>‚ö° Processing Options</h4>
        
        <div class="option-row">
          <div class="option-card">
            <input type="checkbox" id="batchProcessing" checked>
            <div class="option-content">
              <h5>Batch Processing</h5>
              <p>97% memory efficiency with real-time progress</p>
            </div>
          </div>
          
          <div class="option-card">
            <input type="checkbox" id="firebaseUpload" checked>
            <div class="option-content">
              <h5>Firebase Upload</h5>
              <p>Automatic cloud sync with duplicate detection</p>
            </div>
          </div>
        </div>
        
        <div class="option-card">
          <input type="checkbox" id="jsonExport" checked>
          <div class="option-content">
            <h5>JSON Export</h5>
            <p>Local backup with structured data format</p>
          </div>
        </div>
      </div>

      <input type="hidden" name="year" id="yearInput" value="2024" />
      <input type="hidden" name="semester" id="semesterInput" value="1" />

      <button type="submit" id="uploadBtn" disabled>
        <span class="btn-text">‚¨ÜÔ∏è Upload & Process</span>
        <div class="spinner" id="uploadSpinner"></div>
      </button>
    </form>

    <div id="notification"></div>

    <!-- Progress tracking container -->
    <div class="progress-container" id="progressContainer">
      <h3>Upload Progress</h3>
      
      <div class="progress-step" id="step-parsing">
        <div class="step-icon">üìÑ</div>
        <div class="step-text">
          <strong>PDF Parsing</strong>
          <div class="step-details" id="parsing-details">Extracting student data from PDF...</div>
        </div>
      </div>

      <div class="progress-step" id="step-firebase">
        <div class="step-icon">‚òÅÔ∏è</div>
        <div class="step-text">
          <strong>Firebase Upload</strong>
          <div class="step-details" id="firebase-details">Uploading student records in batches...</div>
          <div class="progress-bar">
            <div class="progress-fill" id="firebase-progress"></div>
          </div>
          <div class="batch-info">
            <span id="batch-current">Batch 0/0</span>
            <span id="batch-students">0 students saved</span>
          </div>
        </div>
      </div>

      <div class="progress-step" id="step-storage">
        <div class="step-icon">üíæ</div>
        <div class="step-text">
          <strong>PDF Storage</strong>
          <div class="step-details" id="storage-details">Uploading PDF to cloud storage...</div>
        </div>
      </div>

      <div class="progress-step" id="step-json">
        <div class="step-icon">üìÅ</div>
        <div class="step-text">
          <strong>JSON Backup</strong>
          <div class="step-details" id="json-details">Saving data to local JSON file...</div>
        </div>
      </div>

      <!-- Statistics -->
      <div class="stats-container" id="statsContainer" style="display: none;">
        <div class="stat-card">
          <div class="stat-number" id="stat-total">0</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-firebase">0</div>
          <div class="stat-label">Saved to Firebase</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-time">0s</div>
          <div class="stat-label">Processing Time</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let uploadId = null;
    let progressInterval = null;
    let startTime = null;
    
    // Wait for DOM to load before getting element references
    let uploadBtn, spinner, progressContainer, uploadArea, fileInfo;
    
    document.addEventListener('DOMContentLoaded', function() {
      // Get references to frequently used elements after DOM loads
      uploadBtn = document.getElementById('uploadBtn');
      spinner = document.getElementById('uploadSpinner');
      progressContainer = document.getElementById('progressContainer');
      uploadArea = document.getElementById('uploadArea');
      fileInfo = document.getElementById('fileInfo');
      
      // Set up drag and drop
      setupDragAndDrop();
      
      // Set up file selection
      setupFileSelection();
      
      // Set up form validation
      setupFormValidation();
      
      // Set up form submission
      const uploadForm = document.getElementById('uploadForm');
      uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleUpload();
      });
    });

    function setupDragAndDrop() {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e) {
        uploadArea.classList.add('dragover');
      }

      function unhighlight(e) {
        uploadArea.classList.remove('dragover');
      }

      uploadArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }
    }

    function setupFileSelection() {
      const browseBtn = document.getElementById('browseBtn');
      const pdfInput = document.getElementById('pdfInput');
      const removeFile = document.getElementById('removeFile');

      uploadArea.addEventListener('click', () => pdfInput.click());
      browseBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        pdfInput.click();
      });

      pdfInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      removeFile.addEventListener('click', () => {
        clearFile();
      });
    }

    function handleFiles(files) {
      if (files.length > 0) {
        const file = files[0];
        if (file.type === 'application/pdf') {
          displayFile(file);
          validateForm();
        } else {
          showNotification('‚ùå Please select a PDF file only', 'error');
        }
      }
    }

    function displayFile(file) {
      const fileName = document.getElementById('fileName');
      const fileSize = document.getElementById('fileSize');
      
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      
      uploadArea.style.display = 'none';
      fileInfo.style.display = 'flex';
    }

    function clearFile() {
      document.getElementById('pdfInput').value = '';
      uploadArea.style.display = 'block';
      fileInfo.style.display = 'none';
      validateForm();
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function setupFormValidation() {
      const formatSelect = document.getElementById('formatSelect');
      const examTypeSelect = document.getElementById('examTypeSelect');
      
      formatSelect.addEventListener('change', validateForm);
      examTypeSelect.addEventListener('change', validateForm);
    }

    function validateForm() {
      const hasFile = document.getElementById('pdfInput').files.length > 0;
      const hasFormat = document.getElementById('formatSelect').value !== '';
      const hasExamType = document.getElementById('examTypeSelect').value !== '';
      
      uploadBtn.disabled = !(hasFile && hasFormat && hasExamType);
    }

    function handleUpload() {
      const fileInput = document.getElementById('pdfInput');
      const formatSelect = document.getElementById('formatSelect');
      const examTypeSelect = document.getElementById('examTypeSelect');
      
      if (!fileInput.files[0]) {
        showNotification('‚ùå Please select a PDF file', 'error');
        return;
      }
      
      if (!formatSelect.value) {
        showNotification('‚ùå Please select a format', 'error');
        return;
      }
      
      if (!examTypeSelect.value) {
        showNotification('‚ùå Please select an exam type', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('pdf', fileInput.files[0]);
      formData.append('format', formatSelect.value);
      formData.append('exam_type', examTypeSelect.value);
      
      // Processing options
      const batch = document.getElementById('batchProcessing').checked;
      const quick = document.getElementById('quickProcess').checked;
      const detailed = document.getElementById('detailedStats').checked;
      
      formData.append('batch_processing', batch);
      formData.append('quick_process', quick);
      formData.append('detailed_stats', detailed);

      // UI updates
      uploadBtn.disabled = true;
      spinner.style.display = 'inline-block';
      uploadBtn.querySelector('.btn-text').textContent = 'Processing...';
      
      startTime = Date.now();
      
      fetch('/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.upload_id) {
          uploadId = data.upload_id;
          showNotification('‚úÖ Upload started successfully', 'success');
          startProgressTracking();
        } else if (data.message) {
          showNotification(`‚úÖ ${data.message}`, 'success');
          resetUI();
        } else {
          showNotification('‚ùå Upload failed', 'error');
          resetUI();
        }
      })
      .catch(error => {
        console.error('Upload error:', error);
        showNotification('‚ùå Upload failed', 'error');
        resetUI();
      });
    }

    function startProgressTracking(upload_id) {
      uploadId = upload_id;
      
      if (progressInterval) {
        clearInterval(progressInterval);
      }
      
      progressInterval = setInterval(() => {
        if (uploadId) {
          fetchProgress(uploadId);
        }
      }, 1000); // Poll every second
    }

    function stopProgressTracking() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      uploadId = null;
    }

    async function fetchProgress(upload_id) {
      try {
        const response = await fetch(`/api/upload-progress/${upload_id}`);
        const progress = await response.json();
        
        console.log('Progress update:', progress); // Debug log
        
        if (response.ok && progress.status !== 'not_found') {
          updateProgressDisplay(progress);
          
          // Check if completed and has final result
          if (progress.status === 'completed') {
            stopProgressTracking();
            
            // Show completion and final results
            if (progress.result) {
              const processingTime = ((Date.now() - startTime) / 1000).toFixed(1);
              displayImmediateResults(progress.result, processingTime);
              showNotification(`‚úÖ Successfully processed ${progress.result.processed_count || 0} student results!`, 'success');
            } else {
              // Generate completion message based on Firebase results
              let completionMessage = '‚úÖ Upload completed successfully!';
              let messageType = 'success';
              
              if (progress.firebase) {
                const saved = progress.firebase.students_saved || 0;
                const skipped = progress.firebase.students_skipped || 0;
                const total = progress.firebase.total_students || 0;
                
                if (skipped > 0 && saved === 0) {
                  completionMessage = `‚ÑπÔ∏è Upload complete! All ${total} students already existed in database. Use "Overwrite duplicates" option to update existing records.`;
                  messageType = 'warning';
                } else if (skipped > 0) {
                  completionMessage = `‚úÖ Upload complete! Saved ${saved} new students, skipped ${skipped} duplicates.`;
                } else if (saved > 0) {
                  completionMessage = `‚úÖ Upload complete! Successfully saved ${saved} students to database.`;
                }
              }
              showNotification(completionMessage, messageType);
            }
            
            // Re-enable upload button
            uploadBtn.disabled = false;
            uploadBtn.textContent = "Upload PDF";
            spinner.style.display = 'none';
          } else if (progress.status === 'error') {
            stopProgressTracking();
            showNotification('‚ùå Upload failed: ' + (progress.error?.message || 'Unknown error'), 'error');
            
            // Re-enable upload button
            uploadBtn.disabled = false;
            uploadBtn.textContent = "Upload PDF";
            spinner.style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Error fetching progress:', error);
      }
    }

    function updateProgressDisplay(progress) {
      // Update parsing step
      if (progress.parsing) {
        updateStep('step-parsing', progress.parsing.status, 
                   progress.parsing.message || 'Parsing PDF...');
        if (progress.parsing.total_students) {
          document.getElementById('parsing-details').innerHTML = 
            `Extracted ${progress.parsing.total_students} student records`;
        }
      }

      // Update Firebase step
      if (progress.firebase) {
        let message = progress.firebase.message || 'Uploading to Firebase...';
        let status = progress.firebase.status;
        
        // Improve messaging for duplicate scenarios
        if (progress.firebase.status === 'completed') {
          const saved = progress.firebase.students_saved || 0;
          const skipped = progress.firebase.students_skipped || 0;
          const total = progress.firebase.total_students || 0;
          
          if (skipped > 0 && saved === 0) {
            message = `All ${total} students already exist in database (${skipped} duplicates skipped)`;
          } else if (skipped > 0) {
            message = `Saved ${saved} new students, skipped ${skipped} duplicates`;
          } else {
            message = `Successfully saved ${saved} students to database`;
          }
        }
        
        updateStep('step-firebase', status, message);
        
        if (progress.firebase.progress !== undefined) {
          const progressBar = document.getElementById('firebase-progress');
          progressBar.style.width = `${progress.firebase.progress}%`;
          
          const batchInfo = document.getElementById('batch-current');
          const studentInfo = document.getElementById('batch-students');
          
          if (progress.firebase.batches) {
            batchInfo.textContent = `Batch ${progress.firebase.batches}`;
          }
          
          if (progress.firebase.students_saved !== undefined) {
            studentInfo.textContent = `${progress.firebase.students_saved} students saved`;
          }
        }
      }

      // Update storage step
      if (progress.storage) {
        updateStep('step-storage', progress.storage.status, 
                   progress.storage.message || 'Uploading PDF...');
      }

      // Update JSON step
      if (progress.json) {
        updateStep('step-json', progress.json.status, 
                   progress.json.message || 'Saving JSON file...');
      }

      // Handle completion
      if (progress.status === 'completed') {
        // Display final results if available
        if (progress.result) {
          displayFinalResults(progress.result);
        }
        
        // Show statistics
        if (progress.parsing && progress.firebase) {
          showStatistics(
            progress.parsing.total_students || 0,
            progress.firebase.students_saved || 0,
            5 // Approximate processing time
          );
        }
        
        // Update button state
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload PDF";
        spinner.style.display = 'none';
        
        showNotification('‚úÖ Processing completed successfully!', 'success');
        
        // Reset form after delay
        setTimeout(() => {
          resetForm();
        }, 3000);
      }
      
      // Handle errors
      if (progress.status === 'error') {
        const uploadBtn = document.getElementById('uploadBtn');
        const spinner = document.getElementById('uploadSpinner');
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Upload PDF";
        spinner.style.display = 'none';
        
        showNotification('‚ùå Processing failed. Please try again.', 'error');
      }
    }

    function displayFinalResults(result) {
      // Update Firebase step with final statistics
      if (result.firebase) {
        const firebaseStats = result.firebase;
        if (firebaseStats.enabled) {
          updateStep('step-firebase', 'completed', 
            `‚úÖ Uploaded ${firebaseStats.students_saved}/${firebaseStats.students_total} students to Firebase`);
          
          // Update progress bar to 100%
          document.getElementById('firebase-progress').style.width = '100%';
          document.getElementById('batch-current').textContent = 'Completed';
          document.getElementById('batch-students').textContent = `${firebaseStats.students_saved} students saved`;
        } else {
          updateStep('step-firebase', 'failed', '‚ùå Firebase not available');
        }
        
        // Update storage step
        if (firebaseStats.storage_url) {
          updateStep('step-storage', 'completed', '‚úÖ PDF uploaded to cloud storage');
        } else {
          updateStep('step-storage', 'completed', '‚úÖ PDF storage completed');
        }
      }
      
      // Update JSON step
      if (result.json_file) {
        updateStep('step-json', 'completed', `‚úÖ Data saved to ${result.json_file}`);
      }
    }

    function resetForm() {
      const uploadForm = document.getElementById('uploadForm');
      uploadForm.reset();
      document.querySelectorAll('.options button').forEach(btn => btn.classList.remove('active'));
      // Re-set default format
      document.querySelector('#formatOptions button[data-value="jntuk"]').click();
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('statsContainer').style.display = 'none';
    }

    function resetUI() {
      uploadBtn.disabled = false;
      spinner.style.display = 'none';
      uploadBtn.querySelector('.btn-text').textContent = 'Process PDF';
      
      // Reset file selection
      clearFile();
      
      // Reset form
      document.getElementById('formatSelect').selectedIndex = 0;
      document.getElementById('examTypeSelect').selectedIndex = 0;
      
      // Reset checkboxes
      document.getElementById('batchProcessing').checked = false;
      document.getElementById('quickProcess').checked = false;
      document.getElementById('detailedStats').checked = false;
      
      // Hide progress container
      if (progressContainer) {
        progressContainer.style.display = 'none';
      }
    }

    function updateStep(stepId, status, message) {
      const step = document.getElementById(stepId);
      const details = step.querySelector('.step-details');
      
      // Remove previous status classes
      step.classList.remove('active', 'completed', 'error');
      
      // Add appropriate status class
      if (status === 'completed' || status === 'success') {
        step.classList.add('completed');
        step.querySelector('.step-icon').textContent = '‚úÖ';
      } else if (status === 'error' || status === 'failed') {
        step.classList.add('error');
        step.querySelector('.step-icon').textContent = '‚ùå';
      } else if (status === 'uploading' || status === 'saving' || status === 'starting') {
        step.classList.add('active');
        step.querySelector('.step-icon').textContent = '‚è≥';
      }
      
      if (details && message) {
        details.textContent = message;
      }
    }

    function showStatistics(total, firebase, time) {
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-firebase').textContent = firebase;
      document.getElementById('stat-time').textContent = `${time}s`;
      document.getElementById('statsContainer').style.display = 'flex';
    }

    function displayImmediateResults(result, processingTime) {
      // Step 2: Firebase upload
      if (result.firebase) {
        const firebaseStats = result.firebase;
        if (firebaseStats.enabled) {
          updateStep('step-firebase', 'completed', 
            `‚úÖ Uploaded ${firebaseStats.students_saved}/${firebaseStats.students_total} students to Firebase (${firebaseStats.upload_time?.toFixed(1) || 0}s)`);
          
          // Update progress bar to 100%
          document.getElementById('firebase-progress').style.width = '100%';
          document.getElementById('batch-current').textContent = 'Completed';
          document.getElementById('batch-students').textContent = `${firebaseStats.students_saved} students saved`;
        } else {
          updateStep('step-firebase', 'failed', '‚ùå Firebase not available');
        }
        
        // Step 3: Storage
        if (firebaseStats.storage_url) {
          updateStep('step-storage', 'completed', '‚úÖ PDF uploaded to cloud storage');
        } else {
          updateStep('step-storage', 'failed', '‚ùå PDF storage failed');
        }
      } else {
        updateStep('step-firebase', 'failed', '‚ùå Firebase upload information not available');
        updateStep('step-storage', 'failed', '‚ùå Storage information not available');
      }
      
      // Step 4: JSON backup
      updateStep('step-json', 'completed', `‚úÖ Data saved to ${result.json_file || 'JSON file'}`);
      
      // Show statistics
      showStatistics(result.processed_count || 0, result.firebase?.students_saved || 0, processingTime);
      
      // Reset form on success after a delay
      setTimeout(() => {
        uploadForm.reset();
        document.querySelectorAll('.options button').forEach(btn => btn.classList.remove('active'));
        // Re-set default format
        document.querySelector('#formatOptions button[data-value="jntuk"]').click();
      }, 3000);
    }

    function activateButtons(groupId, hiddenInputId) {
      const buttons = document.querySelectorAll(`#${groupId} button`);
      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          buttons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(hiddenInputId).value = btn.dataset.value;
        });
      });
    }

    activateButtons('yearOptions', 'yearInput');
    activateButtons('semesterOptions', 'semesterInput');
    activateButtons('examTypeOptions', 'examTypeInput');
    activateButtons('formatOptions', 'formatInput');

    // Set default format
    document.querySelector('#formatOptions button[data-value="jntuk"]').click();
    
    const uploadForm = document.getElementById('uploadForm');
    const notification = document.getElementById('notification');

    uploadForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('pdfInput');
      const format = document.getElementById('formatInput').value;

      // Only check for file and format - these are the only visible fields
      if (!fileInput.files[0]) {
        showNotification("‚ùå Please select a PDF file", "error");
        return;
      }

      if (!format) {
        showNotification("‚ùå Please select a format (JNTUK or Autonomous)", "error");
        return;
      }

      // Set default values for required fields that aren't visible
      document.getElementById('examTypeInput').value = 'regular';
      document.getElementById('yearInput').value = '2024';
      document.getElementById('semesterInput').value = '1';

      // Start loading state and show progress
      uploadBtn.disabled = true;
      uploadBtn.textContent = "Processing...";
      spinner.style.display = 'block';
      document.getElementById('notification').style.display = 'none';
      progressContainer.style.display = 'block';
      
      // Reset progress steps
      resetProgressSteps();
      
      // Start timing
      startTime = Date.now(); // Use global variable

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);
      formData.append('format', format);
      formData.append('exam_type', 'regular'); // Default value

      try {
        // Step 1: Start parsing
        updateStep('step-parsing', 'active', 'Extracting student data from PDF...');
        
        // Create headers object without Content-Type (browser will set it)
        const response = await fetch("/api/upload-result", {
          method: "POST",
          body: formData
        });

        const result = await response.json();
        
        if (response.ok && result.upload_id) {
          // Start progress tracking immediately
          startProgressTracking(result.upload_id);
          
          // The rest will be handled by progress polling
          showNotification(`Upload started successfully! Processing...`, 'success');
        } else {
          throw new Error(result.error || 'Upload failed');
        }
      } catch (err) {
        console.error('Upload error:', err);
        
        // Mark all steps as failed
        updateStep('step-parsing', 'failed', '‚ùå Network error');
        updateStep('step-firebase', 'failed', '‚ùå Upload aborted');
        updateStep('step-storage', 'failed', '‚ùå Storage aborted');
        updateStep('step-json', 'failed', '‚ùå JSON save aborted');
        
        showNotification("‚ùå Error uploading PDF", "error");
      } finally {
        // Reset loading state
        uploadBtn.disabled = false;
        uploadBtn.textContent = "‚¨ÜÔ∏è Upload";
        spinner.style.display = 'none';
      }
    });

    function resetProgressSteps() {
      const steps = ['step-parsing', 'step-firebase', 'step-storage', 'step-json'];
      steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        step.className = 'progress-step';
      });
      
      // Reset progress bar
      document.getElementById('firebase-progress').style.width = '0%';
      document.getElementById('batch-current').textContent = 'Batch 0/0';
      document.getElementById('batch-students').textContent = '0 students saved';
      
      // Hide statistics
      document.getElementById('statsContainer').style.display = 'none';
    }

    function updateStep(stepId, status, message) {
      const step = document.getElementById(stepId);
      const details = document.getElementById(stepId.replace('step-', '') + '-details');
      
      step.className = `progress-step ${status}`;
      if (details) {
        details.textContent = message;
      }
    }

    function simulateBatchProgress(saved, total) {
      const progressBar = document.getElementById('firebase-progress');
      const batchCurrent = document.getElementById('batch-current');
      const batchStudents = document.getElementById('batch-students');
      
      // Simulate batch upload (assuming 100 students per batch)
      const batchSize = 100;
      const totalBatches = Math.ceil(total / batchSize);
      
      if (saved > 0) {
        progressBar.style.width = '100%';
        batchCurrent.textContent = `Batch ${totalBatches}/${totalBatches}`;
        batchStudents.textContent = `${saved} students saved`;
      }
    }

    function showStatistics(total, firebase, time) {
      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-firebase').textContent = firebase;
      document.getElementById('stat-time').textContent = time + 's';
      document.getElementById('statsContainer').style.display = 'grid';
    }

    function showNotification(msg, type) {
      notification.textContent = msg;
      notification.className = type;
      notification.style.display = 'block';
    }
  </script>

</body>
</html>