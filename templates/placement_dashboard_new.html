<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement Dashboard - Student Result Analysis</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modern-design.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .placement-page {
            min-height: 100vh;
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 30%, #6366f1 70%, #4338ca 100%);
            padding: 2rem 0;
        }

        .placement-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .placement-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .placement-header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .placement-header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .placement-analysis {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .analysis-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f3f4f6;
        }

        .analysis-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .analysis-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: var(--primary-color);
            background: white;
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .criteria-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .criteria-card:hover {
            background: white;
            border-color: var(--primary-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .criteria-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .criteria-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .criteria-title {
            font-weight: 700;
            color: var(--text-color);
        }

        .criteria-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .criteria-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .criteria-stat {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .criteria-stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .criteria-stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .quick-actions {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .quick-actions h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-decoration: none;
            color: var(--text-color);
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .action-icon {
            width: 24px;
            height: 24px;
        }

        .recent-activity {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .activity-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .activity-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .coming-soon {
            text-align: center;
            padding: 3rem;
            background: #f8fafc;
            border-radius: 16px;
            border: 2px dashed #d1d5db;
            margin: 2rem 0;
        }

        .coming-soon-icon {
            width: 64px;
            height: 64px;
            color: #9ca3af;
            margin: 0 auto 1rem;
        }

        .coming-soon h3 {
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }

        .coming-soon p {
            color: var(--text-secondary);
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .placement-container {
                padding: 0 1rem;
            }

            .placement-header h1 {
                font-size: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }

            .criteria-grid {
                grid-template-columns: 1fr;
            }

            .analysis-filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Modern Navigation -->
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="navbar-brand">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    <path d="M8 7h8"></path>
                    <path d="M8 11h8"></path>
                    <path d="M8 15h6"></path>
                </svg>
                <span>Result Management</span>
            </a>
            
            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Dashboard</a></li>
                <li><a href="/upload" class="navbar-link">Upload Results</a></li>
                <li><a href="/placement" class="navbar-link active">Placement</a></li>
                <li><a href="/training-placement" class="navbar-link">Training & Placement</a></li>
                <li><a href="{{ url_for('data_files') }}" class="navbar-link">Data Files</a></li>
            </ul>
            
            <div class="navbar-actions">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/logout'">
                    <i data-lucide="log-out"></i>
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="placement-page">
        <div class="placement-container">
            <!-- Header -->
            <div class="placement-header">
                <h1>Placement Dashboard</h1>
                <p>Analyze student placement eligibility and performance metrics</p>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i data-lucide="users"></i>
                    </div>
                    <div class="stat-number" id="totalStudents">-</div>
                    <div class="stat-label">Total Students</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i data-lucide="check-circle"></i>
                    </div>
                    <div class="stat-number" id="eligibleStudents">-</div>
                    <div class="stat-label">Placement Eligible</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i data-lucide="trending-up"></i>
                    </div>
                    <div class="stat-number" id="avgCgpa">-</div>
                    <div class="stat-label">Average CGPA</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">
                        <i data-lucide="award"></i>
                    </div>
                    <div class="stat-number" id="topPerformers">-</div>
                    <div class="stat-label">Top Performers</div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Placement Analysis -->
                <div class="placement-analysis">
                    <div class="analysis-header">
                        <h2 class="analysis-title">Placement Criteria Analysis</h2>
                        <div class="analysis-filters">
                            <select class="filter-select" id="branchFilter">
                                <option value="all">All Branches</option>
                                <option value="cse">Computer Science</option>
                                <option value="ece">Electronics</option>
                                <option value="mech">Mechanical</option>
                                <option value="civil">Civil</option>
                            </select>
                            <select class="filter-select" id="semesterFilter">
                                <option value="all">All Semesters</option>
                                <option value="1">Semester 1</option>
                                <option value="2">Semester 2</option>
                                <option value="3">Semester 3</option>
                                <option value="4">Semester 4</option>
                            </select>
                        </div>
                    </div>

                    <!-- Coming Soon Message -->
                    <div class="coming-soon">
                        <i data-lucide="construction" class="coming-soon-icon"></i>
                        <h3>Placement Analysis Coming Soon</h3>
                        <p>We're working on advanced placement criteria analysis features. This will include CGPA-based eligibility, company-specific requirements, and detailed performance metrics.</p>
                    </div>

                    <!-- Placeholder Criteria Cards -->
                    <div class="criteria-grid">
                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-icon">
                                    <i data-lucide="graduation-cap"></i>
                                </div>
                                <div class="criteria-title">CGPA Criteria</div>
                            </div>
                            <div class="criteria-description">
                                Students meeting minimum CGPA requirements for placement eligibility
                            </div>
                            <div class="criteria-stats">
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">75%</div>
                                    <div class="criteria-stat-label">Eligible</div>
                                </div>
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">8.2</div>
                                    <div class="criteria-stat-label">Min CGPA</div>
                                </div>
                            </div>
                        </div>

                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-icon">
                                    <i data-lucide="book-open"></i>
                                </div>
                                <div class="criteria-title">Academic Performance</div>
                            </div>
                            <div class="criteria-description">
                                Students with no backlogs and consistent academic performance
                            </div>
                            <div class="criteria-stats">
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">85%</div>
                                    <div class="criteria-stat-label">No Backlogs</div>
                                </div>
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">92%</div>
                                    <div class="criteria-stat-label">Pass Rate</div>
                                </div>
                            </div>
                        </div>

                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-icon">
                                    <i data-lucide="target"></i>
                                </div>
                                <div class="criteria-title">Skill Assessment</div>
                            </div>
                            <div class="criteria-description">
                                Technical and soft skills evaluation for industry readiness
                            </div>
                            <div class="criteria-stats">
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">68%</div>
                                    <div class="criteria-stat-label">Ready</div>
                                </div>
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">32%</div>
                                    <div class="criteria-stat-label">Training</div>
                                </div>
                            </div>
                        </div>

                        <div class="criteria-card">
                            <div class="criteria-header">
                                <div class="criteria-icon">
                                    <i data-lucide="briefcase"></i>
                                </div>
                                <div class="criteria-title">Industry Readiness</div>
                            </div>
                            <div class="criteria-description">
                                Overall readiness for placement based on multiple criteria
                            </div>
                            <div class="criteria-stats">
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">72%</div>
                                    <div class="criteria-stat-label">Ready</div>
                                </div>
                                <div class="criteria-stat">
                                    <div class="criteria-stat-number">A</div>
                                    <div class="criteria-stat-label">Grade</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="action-buttons">
                        <a href="/upload" class="action-btn">
                            <i data-lucide="upload" class="action-icon"></i>
                            Upload Results
                        </a>
                        <a href="/data-files" class="action-btn">
                            <i data-lucide="database" class="action-icon"></i>
                            View Data Files
                        </a>
                        <a href="#" class="action-btn" onclick="generateReport()">
                            <i data-lucide="file-text" class="action-icon"></i>
                            Generate Report
                        </a>
                        <a href="#" class="action-btn" onclick="exportData()">
                            <i data-lucide="download" class="action-icon"></i>
                            Export Data
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="recent-activity">
                <div class="activity-header">
                    <h2 class="activity-title">Recent Activity</h2>
                    <a href="#" class="btn btn-outline">View All</a>
                </div>
                <div class="activity-list">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i data-lucide="upload"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">New result file uploaded</div>
                            <div class="activity-time">2 hours ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i data-lucide="users"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">Placement analysis performed</div>
                            <div class="activity-time">4 hours ago</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i data-lucide="database"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">Database synchronized</div>
                            <div class="activity-time">6 hours ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Back to Dashboard Button -->
    <div class="floating-action">
        <a href="/" class="btn btn-secondary">
            <i data-lucide="arrow-left"></i>
            Back to Dashboard
        </a>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Real-time statistics from API
        let currentStats = {
            totalStudents: 0,
            eligibleStudents: 0,
            avgCgpa: 0.0,
            topPerformers: 0
        };

        // Fetch real placement statistics
        async function fetchPlacementStats() {
            try {
                const response = await fetch('/api/placement/students-analysis');
                if (response.ok) {
                    const data = await response.json();
                    currentStats = {
                        totalStudents: data.total_students || 0,
                        eligibleStudents: data.eligible_count || 0,
                        avgCgpa: parseFloat(data.average_cgpa || 0).toFixed(2),
                        topPerformers: data.top_performers || 0
                    };
                    return true;
                } else {
                    console.error('Failed to fetch placement stats:', response.statusText);
                    return false;
                }
            } catch (error) {
                console.error('Error fetching placement stats:', error);
                return false;
            }
        }

        // Update statistics
        async function updateStatistics() {
            // Show loading state
            setLoadingState(true);
            
            const success = await fetchPlacementStats();
            
            if (success) {
                document.getElementById('totalStudents').textContent = currentStats.totalStudents.toLocaleString();
                document.getElementById('eligibleStudents').textContent = currentStats.eligibleStudents.toLocaleString();
                document.getElementById('avgCgpa').textContent = currentStats.avgCgpa;
                document.getElementById('topPerformers').textContent = currentStats.topPerformers.toLocaleString();
            } else {
                // Fallback to show error message
                showErrorMessage('Failed to load placement statistics. Please refresh the page.');
            }
            
            setLoadingState(false);
        }

        // Show loading state for stat cards
        function setLoadingState(isLoading) {
            const statCards = document.querySelectorAll('.stat-card');
            statCards.forEach(card => {
                if (isLoading) {
                    card.style.opacity = '0.6';
                } else {
                    card.style.opacity = '1';
                }
            });
        }

        // Show error message
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.innerHTML = `
                <i data-lucide="alert-triangle"></i>
                <span>${message}</span>
            `;
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #fee2e2;
                color: #dc2626;
                padding: 1rem;
                border-radius: 8px;
                border: 1px solid #fecaca;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            document.body.appendChild(errorDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Generate report function
        async function generateReport() {
            // Show loading state
            const btn = event.target.closest('.action-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="action-icon animate-spin"></i>Generating...';
            
            try {
                const response = await fetch('/api/placement/eligible-students');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create and download report
                    const reportData = {
                        timestamp: new Date().toISOString(),
                        total_students: data.total_students,
                        eligible_count: data.eligible_count,
                        students: data.students
                    };
                    
                    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `placement_report_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessMessage('Placement report generated successfully!');
                } else {
                    throw new Error('Failed to generate report');
                }
            } catch (error) {
                console.error('Report generation error:', error);
                showErrorMessage('Failed to generate report. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        // Export data function
        async function exportData() {
            // Show loading state
            const btn = event.target.closest('.action-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="action-icon animate-spin"></i>Exporting...';
            
            try {
                const response = await fetch('/api/placement/students-analysis');
                if (response.ok) {
                    const data = await response.json();
                    
                    // Create CSV content
                    const csvContent = [
                        ['Student ID', 'Name', 'CGPA', 'Backlogs', 'Eligible'].join(','),
                        ...data.students.map(student => [
                            student.student_id,
                            student.name || 'N/A',
                            student.cgpa || 'N/A',
                            student.backlogs || 0,
                            student.placement_eligible ? 'Yes' : 'No'
                        ].join(','))
                    ].join('\\n');
                    
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `placement_data_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showSuccessMessage('Data exported successfully!');
                } else {
                    throw new Error('Failed to export data');
                }
            } catch (error) {
                console.error('Export error:', error);
                showErrorMessage('Failed to export data. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                lucide.createIcons();
            }
        }

        // Show success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.innerHTML = `
                <i data-lucide="check-circle"></i>
                <span>${message}</span>
            `;
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #d1fae5;
                color: #065f46;
                padding: 1rem;
                border-radius: 8px;
                border: 1px solid #a7f3d0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                z-index: 1000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            document.body.appendChild(successDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 3000);
        }

        // Filter change handlers
        document.getElementById('branchFilter').addEventListener('change', async function() {
            console.log('Branch filter changed:', this.value);
            await updateStatisticsWithFilters();
        });

        document.getElementById('semesterFilter').addEventListener('change', async function() {
            console.log('Semester filter changed:', this.value);
            await updateStatisticsWithFilters();
        });

        // Update statistics with current filter values
        async function updateStatisticsWithFilters() {
            const branch = document.getElementById('branchFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            
            setLoadingState(true);
            
            try {
                let url = '/api/placement/students-analysis?';
                const params = new URLSearchParams();
                
                if (branch && branch !== 'all') {
                    params.append('branch', branch);
                }
                if (semester && semester !== 'all') {
                    params.append('semester', semester);
                }
                
                const response = await fetch(url + params.toString());
                if (response.ok) {
                    const data = await response.json();
                    currentStats = {
                        totalStudents: data.total_students || 0,
                        eligibleStudents: data.eligible_count || 0,
                        avgCgpa: parseFloat(data.average_cgpa || 0).toFixed(2),
                        topPerformers: data.top_performers || 0
                    };
                    
                    document.getElementById('totalStudents').textContent = currentStats.totalStudents.toLocaleString();
                    document.getElementById('eligibleStudents').textContent = currentStats.eligibleStudents.toLocaleString();
                    document.getElementById('avgCgpa').textContent = currentStats.avgCgpa;
                    document.getElementById('topPerformers').textContent = currentStats.topPerformers.toLocaleString();
                } else {
                    showErrorMessage('Failed to load filtered data.');
                }
            } catch (error) {
                console.error('Filter update error:', error);
                showErrorMessage('Error applying filters.');
            }
            
            setLoadingState(false);
        }

        // Initialize the page
        window.addEventListener('load', function() {
            updateStatistics();
        });
    </script>
</body>
</html>
